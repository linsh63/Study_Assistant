<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>番茄钟</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Quicksand:wght@300;500;700&display=swap');
        
        :root {
            --primary-color: #4f46e5;
            --secondary-color: #10b981;
            --dark-color: #1e293b;
            --light-color: #f8fafc;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Quicksand', sans-serif;
        }
        
        body {
            min-height: 100vh;
            overflow-x: hidden;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        /* 背景容器 */
        .bg-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -2;
        }
        
        /* 静态背景 */
        .static-bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            opacity: 0.7;
            transition: opacity 0.5s ease;
        }
        
        /* 动态背景 */
        .dynamic-bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            transition: opacity 0.5s ease;
        }
        
        .dynamic-bg.active {
            opacity: 0.8;
        }
        
        /* 动态背景动画 */
        @keyframes meteor {
            0% {
                transform: translate(-100px, -100px) rotate(45deg);
                opacity: 1;
            }
            100% {
                transform: translate(calc(100vw + 100px), calc(100vh + 100px)) rotate(45deg);
                opacity: 0;
            }
        }
        
        @keyframes snow {
            0% {
                transform: translateY(0) translateX(0);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 0.9;
            }
            100% {
                transform: translateY(100vh) translateX(20px);
                opacity: 0;
            }
        }
        
        @keyframes aurora {
            0%, 100% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
        }
        
        /* 动态背景样式 */
        .meteor-bg {
            background: radial-gradient(ellipse at bottom, #1B2735 0%, #090A0F 100%);
            overflow: hidden;
            position: relative;
        }
        
        /* 雪花背景 */
        .snow-bg {
            background: linear-gradient(to bottom, #123 30%, #667);
            overflow: hidden;
            position: relative;
        }
        
        .snow-bg .snowflake {
            position: absolute;
            width: 6px;
            height: 6px;
            background: white;
            border-radius: 50%;
            box-shadow: 0 0 5px rgba(255, 255, 255, 0.8);
            filter: blur(1px);
        }
        
        .snow-bg .snowflake:nth-child(1) {
            width: 3px;
            height: 3px;
            top: 10%;
            left: 10%;
            animation: snow 8s linear infinite;
            animation-delay: 0s;
        }
        
        .snow-bg .snowflake:nth-child(2) {
            width: 5px;
            height: 5px;
            top: 20%;
            left: 30%;
            animation: snow 10s linear infinite;
            animation-delay: 1s;
        }
        
        .snow-bg .snowflake:nth-child(3) {
            width: 4px;
            height: 4px;
            top: 5%;
            left: 50%;
            animation: snow 7s linear infinite;
            animation-delay: 2s;
        }
        
        .snow-bg .snowflake:nth-child(4) {
            width: 6px;
            height: 6px;
            top: 15%;
            left: 70%;
            animation: snow 11s linear infinite;
            animation-delay: 0.5s;
        }
        
        .snow-bg .snowflake:nth-child(5) {
            width: 4px;
            height: 4px;
            top: 25%;
            left: 90%;
            animation: snow 9s linear infinite;
            animation-delay: 1.5s;
        }
        
        .snow-bg .snowflake:nth-child(6) {
            width: 5px;
            height: 5px;
            top: 5%;
            left: 15%;
            animation: snow 8.5s linear infinite;
            animation-delay: 3s;
        }
        
        .snow-bg .snowflake:nth-child(7) {
            width: 3px;
            height: 3px;
            top: 15%;
            left: 35%;
            animation: snow 10.5s linear infinite;
            animation-delay: 2.5s;
        }
        
        .snow-bg .snowflake:nth-child(8) {
            width: 4px;
            height: 4px;
            top: 8%;
            left: 55%;
            animation: snow 7.5s linear infinite;
            animation-delay: 1.8s;
        }
        
        .snow-bg .snowflake:nth-child(9) {
            width: 6px;
            height: 6px;
            top: 18%;
            left: 75%;
            animation: snow 9.5s linear infinite;
            animation-delay: 0.2s;
        }
        
        .snow-bg .snowflake:nth-child(10) {
            width: 5px;
            height: 5px;
            top: 22%;
            left: 95%;
            animation: snow 8.2s linear infinite;
            animation-delay: 1.2s;
        }
        
        .meteor-bg::before,
        .meteor-bg::after,
        .meteor-bg .meteor-1,
        .meteor-bg .meteor-2,
        .meteor-bg .meteor-3,
        .meteor-bg .meteor-4,
        .meteor-bg .meteor-5 {
            content: "";
            position: absolute;
            background: linear-gradient(45deg, 
                rgba(0,0,0,0) 0%, 
                rgba(0,0,0,0) 85%, 
                rgba(255,255,255,0.6) 90%, 
                rgba(0,0,0,0) 95%
            );
            width: 100px;
            height: 2px;
            border-radius: 50%;
            box-shadow: 0 0 5px 1px rgba(255, 255, 255, 0.3);
            opacity: 1; /* 修改这里，从0改为1 */
        }
        
        .meteor-bg::before {
            top: 10%;
            left: 20%;
            animation: meteor 2s linear 0s infinite;
            animation-delay: 1.1s;
        }
        
        .meteor-bg::after {
            top: 30%;
            left: 70%;
            animation: meteor 3s linear 0s infinite;
            animation-delay: 2.3s;
        }
        
        .aurora-bg {
            background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
            background-size: 400% 400%;
            animation: aurora 15s ease infinite;
        }
        
        /* 主容器 */
        .main-container {
            width: 90%;
            max-width: 800px;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            padding: 2rem;
            margin: 1rem auto;
            display: flex;
            flex-direction: column;
            position: absolute; /* 改为绝对定位，以便拖动 */
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            cursor: move; /* 添加移动光标 */
            user-select: none; /* 防止文本被选中 */
            z-index: 10; /* 确保在其他元素上方 */
        }
        
        /* 计时器容器 */
        .timer-container {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 1rem 0;
        }
        
        /* 翻页时钟 */
        .flip-clock {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            perspective: 1000px;
            height: 220px;
            margin-bottom: 2rem;
        }
        
        .flip-card {
            position: relative;
            width: 140px;
            height: 200px;
            font-size: 10rem;
            font-weight: bold;
            line-height: 1;
            color: white;
        }
        
        .flip-card-wrapper {
            position: relative;
            width: 100%;
            height: 100%;
            transform-style: preserve-3d;
        }
        
        .flip-card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background: rgba(15, 23, 42, 0.9);
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            backface-visibility: hidden;
        }
        
        .flip-card-face.top {
            transform-origin: bottom center;
            transform: rotateX(0deg);
            z-index: 2;
            background: rgba(15, 23, 42, 0.95);
        }
        
        .flip-card-face.bottom {
            transform-origin: top center;
            transform: rotateX(90deg);
            background: rgba(15, 23, 42, 0.9);
        }
        
        .flip-card-face.next {
            transform-origin: bottom center;
            transform: rotateX(-90deg);
            z-index: 3;
            background: rgba(15, 23, 42, 0.95);
        }
        
        .colon {
            font-size: 8rem;
            color: white;
            margin: 0 0.5rem;
            text-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }
        
        /* 数字时钟样式 */
        .digital-clock {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
            height: 220px;
            margin-bottom: 2rem;
        }
        
        .digital-unit {
            position: relative;
            width: 140px;
            height: 200px;
            background: #1e1e1e;
            border-radius: 10px;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.5);
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .digital-number {
            font-family: 'Orbitron', sans-serif;
            font-size: 10rem;
            font-weight: bold;
            color: #ddd;
            text-shadow: 0 0 10px rgba(79, 70, 229, 0.7);
        }
        
        .digital-colon {
            font-family: 'Orbitron', sans-serif;
            font-size: 8rem;
            font-weight: bold;
            color: #ddd;
            text-shadow: 0 0 10px rgba(79, 70, 229, 0.7);
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0%, 49% {
                opacity: 1;
            }
            50%, 100% {
                opacity: 0.5;
            }
        }
        
        @media (max-width: 768px) {
            .digital-clock {
                height: 150px;
                gap: 0.3rem;
            }
            
            .digital-unit {
                width: 70px;
                height: 100px;
            }
            
            .digital-number {
                font-size: 5rem;
            }
            
            .digital-colon {
                font-size: 4rem;
            }
        }

        /* 按钮容器 */
        .control-buttons {
            display: flex;
            justify-content: center;
            gap: 1rem;
            width: 100%;
            margin-top: 1rem;
        }
        
        .control-button {
            padding: 0.75rem 1.5rem;
            border-radius: 10px;
            font-weight: bold;
            display: flex;
            align-items: center;
            transition: all 0.3s ease;
        }
        
        /* 设置面板 */
        .settings-panel {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        
        .settings-panel.open {
            opacity: 1;
            pointer-events: all;
        }
        
        .settings-content {
            background: rgba(31, 41, 55, 0.95);
            border-radius: 20px;
            padding: 2rem;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        /* 响应式调整 */
        @media (max-width: 768px) {
            .main-container {
                padding: 1.5rem;
                width: 95%;
            }
            
            .flip-clock {
                height: 150px;
                gap: 0.5rem;
            }
            
            .flip-card {
                width: 70px;
                height: 100px;
                font-size: 5rem;
            }
            
            .colon {
                font-size: 4rem;
            }
            
            .control-buttons {
                flex-wrap: wrap;
            }
            
            .control-button {
                padding: 0.5rem 1rem;
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
    <!-- 背景容器 -->
    <div class="bg-container">
        <div id="static-bg" class="static-bg" style="background-image: url('https://source.unsplash.com/random/1920x1080/?nature')"></div>
        <div id="dynamic-bg" class="dynamic-bg aurora-bg">
            <!-- 雪花元素 -->
            <div class="snowflake"></div>
            <div class="snowflake"></div>
            <div class="snowflake"></div>
            <div class="snowflake"></div>
            <div class="snowflake"></div>
            <div class="snowflake"></div>
            <div class="snowflake"></div>
            <div class="snowflake"></div>
            <div class="snowflake"></div>
            <div class="snowflake"></div>
            <!-- 流星元素 -->
            <div class="meteor-1"></div>
            <div class="meteor-2"></div>
            <div class="meteor-3"></div>
            <div class="meteor-4"></div>
            <div class="meteor-5"></div>
        </div>
    </div>
    
    <!-- 主容器 -->
    <div class="main-container">
        <!-- 顶部工具栏 -->
        <div class="flex justify-between items-center mb-4">
            <h1 class="text-2xl font-bold text-white flex items-center">
                <i class="fas fa-clock mr-2 text-indigo-400"></i>
                <span class="bg-gradient-to-r from-indigo-400 to-purple-600 bg-clip-text text-transparent">番茄钟</span>
            </h1>
            <div class="flex items-center">
                <a href="pomodoro-stats.html" class="p-2 mr-2 rounded-full hover:bg-gray-700 transition-all text-gray-400 hover:text-gray-200" title="任务统计">
                    <i class="fas fa-chart-bar text-sm"></i>
                </a>
                <a href="dashboard.html" class="p-2 mr-2 rounded-full hover:bg-gray-700 transition-all text-gray-400 hover:text-gray-200" title="返回主页">
                    <i class="fas fa-home text-sm"></i>
                </a>
                <button id="settings-btn" class="p-2 rounded-full hover:bg-gray-700 transition-all">
                    <i class="fas fa-cog text-xl text-gray-300 hover:text-white"></i>
                </button>
            </div>
        </div>
        
        <!-- 模式切换 -->
        <div class="flex justify-center mb-6">
            <div class="inline-flex bg-gray-800 rounded-lg p-1">
                <button id="work-mode" class="px-4 py-2 rounded-lg font-medium text-white bg-indigo-600">工作模式</button>
                <button id="break-mode" class="px-4 py-2 rounded-lg font-medium text-gray-300 hover:text-white">休息模式</button>
            </div>
        </div>
        
        <!-- 添加任务名称显示 -->
        <div id="task-display" class="text-center mb-4 text-xl font-medium text-white opacity-80">
            <span id="current-task">专注工作中...</span>
        </div>
        
        <!-- 计时器显示 -->
        <div class="timer-container">
            <div class="flip-clock" id="timer-display">
                <div class="flip-card" id="minute-tens">
                    <div class="flip-card-wrapper">
                        <div class="flip-card-face top">2</div>
                        <div class="flip-card-face bottom">2</div>
                        <div class="flip-card-face next">2</div>
                    </div>
                </div>
                <div class="flip-card" id="minute-ones">
                    <div class="flip-card-wrapper">
                        <div class="flip-card-face top">5</div>
                        <div class="flip-card-face bottom">5</div>
                        <div class="flip-card-face next">5</div>
                    </div>
                </div>
                <div class="colon">:</div>
                <div class="flip-card" id="second-tens">
                    <div class="flip-card-wrapper">
                        <div class="flip-card-face top">0</div>
                        <div class="flip-card-face bottom">0</div>
                        <div class="flip-card-face next">0</div>
                    </div>
                </div>
                <div class="flip-card" id="second-ones">
                    <div class="flip-card-wrapper">
                        <div class="flip-card-face top">0</div>
                        <div class="flip-card-face bottom">0</div>
                        <div class="flip-card-face next">0</div>
                    </div>
                </div>
            </div>
            
            <!-- 控制按钮 -->
            <div class="control-buttons">
                <button id="start-btn" class="control-button bg-green-600 text-white hover:bg-green-700">
                    <i class="fas fa-play mr-2"></i>开始
                </button>
                <button id="pause-btn" class="control-button bg-yellow-600 text-white hover:bg-yellow-700" disabled>
                    <i class="fas fa-pause mr-2"></i>暂停
                </button>
                <button id="reset-btn" class="control-button bg-red-600 text-white hover:bg-red-700">
                    <i class="fas fa-redo mr-2"></i>重置
                </button>
            </div>
        </div>
    </div>
    
    <!-- 设置面板 -->
    <div id="settings-panel" class="settings-panel">
        <div class="settings-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-white">设置</h2>
                <button id="close-settings" class="p-2 rounded-full hover:bg-gray-700">
                    <i class="fas fa-times text-xl text-gray-300"></i>
                </button>
            </div>
            
            <div class="space-y-6">
                <!-- 工作/休息时间设置 -->
                <div>
                    <h3 class="text-lg font-medium text-white mb-3">时间设置</h3>
                    <!-- 添加任务名称设置 -->
                    <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-300 mb-1">任务名称</label>
                    <input type="text" id="task-name" class="w-full bg-gray-700 text-white rounded-lg p-2" 
                            placeholder="输入当前任务名称">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-1">工作时间 (分钟)</label>
                            <select id="work-time" class="w-full bg-gray-700 text-white rounded-lg p-2">
                                <option value="25">25分钟</option>
                                <option value="30" selected>30分钟</option>
                                <option value="40">40分钟</option>
                                <option value="60">60分钟</option>
                                <option value="custom">自定义</option>
                            </select>
                            <div id="custom-work-container" class="mt-2 hidden">
                                <input type="number" id="custom-work-time" min="1" max="120" 
                                       class="w-full bg-gray-700 text-white rounded-lg p-2" placeholder="输入分钟数">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-1">休息时间 (分钟)</label>
                            <select id="break-time" class="w-full bg-gray-700 text-white rounded-lg p-2">
                                <option value="5">5分钟</option>
                                <option value="10" selected>10分钟</option>
                                <option value="15">15分钟</option>
                                <option value="20">20分钟</option>
                                <option value="custom">自定义</option>
                            </select>
                            <div id="custom-break-container" class="mt-2 hidden">
                                <input type="number" id="custom-break-time" min="1" max="60" 
                                       class="w-full bg-gray-700 text-white rounded-lg p-2" placeholder="输入分钟数">
                            </div>
                        </div>
                    </div>
                </div>
                
                               <!-- 背景设置 -->
                               <div>
                                <h3 class="text-lg font-medium text-white mb-3">背景设置</h3>
                                
                                <div class="mb-4">
                                    <label class="block text-sm font-medium text-gray-300 mb-2">静态背景</label>
                                    <div class="flex space-x-2">
                                        <button id="upload-bg" class="flex-1 bg-gray-700 text-white rounded-lg p-2 mb-2 hover:bg-gray-600">
                                            <i class="fas fa-upload mr-2"></i>上传背景图片
                                        </button>
                                        <button id="remove-bg" class="bg-red-600 text-white rounded-lg p-2 mb-2 hover:bg-red-700">
                                            <i class="fas fa-trash-alt"></i>
                                        </button>
                                    </div>
                                    <input type="file" id="bg-upload-input" accept="image/*" class="hidden">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-2">动态背景效果</label>
                                    <div class="grid grid-cols-2 gap-2">
                                        <button data-bg="none" class="bg-gray-700 text-white rounded-lg p-2 hover:bg-gray-600">
                                            无动态背景
                                        </button>
                                        <button data-bg="aurora" class="bg-gray-700 text-white rounded-lg p-2 hover:bg-gray-600">
                                            极光效果
                                        </button>
                                        <button data-bg="meteor" class="bg-gray-700 text-white rounded-lg p-2 hover:bg-gray-600">
                                            流星雨
                                        </button>
                                        <button data-bg="snow" class="bg-gray-700 text-white rounded-lg p-2 hover:bg-gray-600">
                                            下雪效果
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 添加显示方式设置 -->
                            <div>
                                <h3 class="text-lg font-medium text-white mb-3">显示设置</h3>
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-2">计时器显示方式</label>
                                    <div class="grid grid-cols-3 gap-2">
                                        <button id="flip-display" class="bg-indigo-600 text-white rounded-lg p-2 hover:bg-indigo-700">
                                            翻页显示
                                        </button>
                                        <button id="normal-display" class="bg-gray-700 text-white rounded-lg p-2 hover:bg-gray-600">
                                            普通显示
                                        </button>
                                        <button id="digital-display" class="bg-gray-700 text-white rounded-lg p-2 hover:bg-gray-600">
                                            数字时钟
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="pt-4">
                                <button id="save-settings" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-lg hover:bg-indigo-700">
                                    保存设置
                                </button>
                            </div>
            </div>
        </div>
    </div>

    <script>
        // API URL
        const API_URL = 'http://localhost:3000/api';
        let currentUser = null;

        // DOM元素
        const workModeBtn = document.getElementById('work-mode');
        const breakModeBtn = document.getElementById('break-mode');
        const startBtn = document.getElementById('start-btn');
        const pauseBtn = document.getElementById('pause-btn');
        const resetBtn = document.getElementById('reset-btn');
        const minuteTens = document.getElementById('minute-tens');
        const minuteOnes = document.getElementById('minute-ones');
        const secondTens = document.getElementById('second-tens');
        const secondOnes = document.getElementById('second-ones');
        const settingsBtn = document.getElementById('settings-btn');
        const closeSettings = document.getElementById('close-settings');
        const settingsPanel = document.getElementById('settings-panel');
        const workTimeSelect = document.getElementById('work-time');
        const breakTimeSelect = document.getElementById('break-time');
        const customWorkContainer = document.getElementById('custom-work-container');
        const customWorkTime = document.getElementById('custom-work-time');
        const customBreakContainer = document.getElementById('custom-break-container');
        const customBreakTime = document.getElementById('custom-break-time');
        const saveSettingsBtn = document.getElementById('save-settings');
        const uploadBgBtn = document.getElementById('upload-bg');
        const removeBgBtn = document.getElementById('remove-bg');
        const bgUploadInput = document.getElementById('bg-upload-input');
        const staticBg = document.getElementById('static-bg');
        const dynamicBg = document.getElementById('dynamic-bg');
        const taskNameInput = document.getElementById('task-name'); // 添加任务名称输入框引用
        const currentTaskDisplay = document.getElementById('current-task'); // 添加任务名称显示引用
        
        // 动态背景按钮
        const bgButtons = document.querySelectorAll('[data-bg]');
        
        // 计时器变量
        let timer;
        let currentMode = 'work'; // 'work' or 'break'
        let isRunning = false;
        let totalSeconds = 30 * 60; // 默认30分钟工作时间
        let remainingSeconds = totalSeconds;
        let currentDisplay = {
            minuteTens: '2',
            minuteOnes: '5',
            secondTens: '0',
            secondOnes: '0'
        };
        
        // 默认设置
        let settings = {
            workTime: 30,
            breakTime: 10,
            dynamicBg: 'aurora',
            displayMode: 'flip', // 添加显示模式设置，默认为翻页显示
            taskName: '专注工作中...' // 添加任务名称设置，默认值
        };
        // 添加任务记录相关变量
        let currentTaskId = null;
        let taskStartTime = null;
        
        
        // 显示通知
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            const icon = toast.querySelector('i');
            
            toastMessage.textContent = message;
            
            // 设置图标
            if (type === 'success') {
                icon.className = 'fas fa-check-circle';
                icon.style.color = '#28a745';
                toast.style.borderLeft = '4px solid #28a745';
            } else {
                icon.className = 'fas fa-exclamation-circle';
                icon.style.color = '#dc3545';
                toast.style.borderLeft = '4px solid #dc3545';
            }
            
            // 显示通知
            toast.style.opacity = '1';
            toast.style.transform = 'translateY(0)';
            
            // 3秒后隐藏
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateY(-20px)';
            }, 3000);
        }

                // 检查用户是否已登录
                async function checkLogin() {
            try {
                const response = await fetch(`${API_URL}/me`, {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    // 未登录，重定向到登录页面
                    window.location.href = 'login.html';
                    return false;
                }
                
                const user = await response.json();
                currentUser = user;
                
                // 移除显示用户名的代码，只保留登录检查功能
                
                return true;
            } catch (error) {
                console.error('检查登录状态失败:', error);
                window.location.href = 'login.html';
                return false;
            }
        }

       // 初始化
        async function init() {
            // 首先检查登录状态
            const isLoggedIn = await checkLogin();
            if (!isLoggedIn) return;
            
            updateTimerDisplay();
            loadSettings();
            applyBackground();
            
            // 事件监听
            workModeBtn.addEventListener('click', () => switchMode('work'));
            breakModeBtn.addEventListener('click', () => switchMode('break'));
            startBtn.addEventListener('click', startTimer);
            pauseBtn.addEventListener('click', pauseTimer);
            resetBtn.addEventListener('click', resetTimer);
            settingsBtn.addEventListener('click', openSettings);
            closeSettings.addEventListener('click', closeSettingsPanel);
            saveSettingsBtn.addEventListener('click', saveSettings);
            uploadBgBtn.addEventListener('click', () => bgUploadInput.click());
            removeBgBtn.addEventListener('click', removeBackground);
            bgUploadInput.addEventListener('change', handleBgUpload);

           // 添加显示模式按钮事件
           document.getElementById('flip-display').addEventListener('click', () => {
                document.getElementById('flip-display').classList.add('bg-indigo-600');
                document.getElementById('flip-display').classList.remove('bg-gray-700');
                document.getElementById('normal-display').classList.remove('bg-indigo-600');
                document.getElementById('normal-display').classList.add('bg-gray-700');
                document.getElementById('digital-display').classList.remove('bg-indigo-600');
                document.getElementById('digital-display').classList.add('bg-gray-700');
                settings.displayMode = 'flip';
                updateTimerDisplay(); // 立即更新显示
            });
            
            document.getElementById('normal-display').addEventListener('click', () => {
                document.getElementById('normal-display').classList.add('bg-indigo-600');
                document.getElementById('normal-display').classList.remove('bg-gray-700');
                document.getElementById('flip-display').classList.remove('bg-indigo-600');
                document.getElementById('flip-display').classList.add('bg-gray-700');
                document.getElementById('digital-display').classList.remove('bg-indigo-600');
                document.getElementById('digital-display').classList.add('bg-gray-700');
                settings.displayMode = 'normal';
                updateTimerDisplay(); // 立即更新显示
            });

            document.getElementById('digital-display').addEventListener('click', () => {
                document.getElementById('digital-display').classList.add('bg-indigo-600');
                document.getElementById('digital-display').classList.remove('bg-gray-700');
                document.getElementById('flip-display').classList.remove('bg-indigo-600');
                document.getElementById('flip-display').classList.add('bg-gray-700');
                document.getElementById('normal-display').classList.remove('bg-indigo-600');
                document.getElementById('normal-display').classList.add('bg-gray-700');
                settings.displayMode = 'digital';
                updateTimerDisplay(); // 立即更新显示
            });
            
            workTimeSelect.addEventListener('change', function() {
                if (this.value === 'custom') {
                    customWorkContainer.classList.remove('hidden');
                } else {
                    customWorkContainer.classList.add('hidden');
                }
            });
            
            breakTimeSelect.addEventListener('change', function() {
                if (this.value === 'custom') {
                    customBreakContainer.classList.remove('hidden');
                } else {
                    customBreakContainer.classList.add('hidden');
                }
            });
            
            bgButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    const bgType = this.getAttribute('data-bg');
                    setDynamicBackground(bgType);
                    saveSettings();
                });
            });
        }
        
        // 设置动态背景
        function setDynamicBackground(bgType) {
            dynamicBg.className = 'dynamic-bg';
            if (bgType !== 'none') {
                dynamicBg.classList.add(bgType + '-bg', 'active');
                settings.dynamicBg = bgType;
                
                // 如果启用动态背景，则禁用静态背景
                staticBg.style.opacity = '0';
            } else {
                settings.dynamicBg = 'none';
                
                // 如果禁用动态背景，则启用静态背景
                staticBg.style.opacity = '0.7';
            }
            
            // 更新背景按钮的激活状态
            bgButtons.forEach(btn => {
                if (btn.getAttribute('data-bg') === bgType) {
                    btn.classList.add('bg-indigo-600');
                    btn.classList.remove('bg-gray-700');
                } else {
                    btn.classList.remove('bg-indigo-600');
                    btn.classList.add('bg-gray-700');
                }
            });
            
            // 不需要单独控制元素的显示/隐藏，让CSS类处理
            console.log("设置背景为:", bgType);
        }
        
        // 更新计时器显示
        function updateTimerDisplay() {
            const minutes = Math.floor(remainingSeconds / 60);
            const seconds = remainingSeconds % 60;
            
            const minTens = Math.floor(minutes / 10);
            const minOnes = minutes % 10;
            const secTens = Math.floor(seconds / 10);
            const secOnes = seconds % 10;
            
            // 根据显示模式选择不同的显示方法
            if (settings.displayMode === 'digital') {
                // 数字时钟显示模式
                // 首先检查是否需要创建数字时钟元素
                let digitalClock = document.querySelector('.digital-clock');
                if (!digitalClock) {
                    // 创建数字时钟元素
                    const timerDisplay = document.getElementById('timer-display');
                    timerDisplay.innerHTML = ''; // 清空现有内容
                    
                    digitalClock = document.createElement('div');
                    digitalClock.className = 'digital-clock';
                    
                    // 分钟十位
                    const minTensUnit = document.createElement('div');
                    minTensUnit.className = 'digital-unit';
                    minTensUnit.innerHTML = `<div class="digital-number" id="digital-min-tens">${minTens}</div>`;
                    
                    // 分钟个位
                    const minOnesUnit = document.createElement('div');
                    minOnesUnit.className = 'digital-unit';
                    minOnesUnit.innerHTML = `<div class="digital-number" id="digital-min-ones">${minOnes}</div>`;
                    
                    // 冒号
                    const colonDiv = document.createElement('div');
                    colonDiv.className = 'digital-colon';
                    colonDiv.textContent = ':';
                    
                    // 秒钟十位
                    const secTensUnit = document.createElement('div');
                    secTensUnit.className = 'digital-unit';
                    secTensUnit.innerHTML = `<div class="digital-number" id="digital-sec-tens">${secTens}</div>`;
                    
                    // 秒钟个位
                    const secOnesUnit = document.createElement('div');
                    secOnesUnit.className = 'digital-unit';
                    secOnesUnit.innerHTML = `<div class="digital-number" id="digital-sec-ones">${secOnes}</div>`;
                    
                    // 添加到数字时钟容器
                    digitalClock.appendChild(minTensUnit);
                    digitalClock.appendChild(minOnesUnit);
                    digitalClock.appendChild(colonDiv);
                    digitalClock.appendChild(secTensUnit);
                    digitalClock.appendChild(secOnesUnit);
                    
                    // 添加到计时器显示区域
                    timerDisplay.appendChild(digitalClock);
                } else {
                    // 更新现有数字时钟
                    document.getElementById('digital-min-tens').textContent = minTens;
                    document.getElementById('digital-min-ones').textContent = minOnes;
                    document.getElementById('digital-sec-tens').textContent = secTens;
                    document.getElementById('digital-sec-ones').textContent = secOnes;
                }
            } else if (settings.displayMode === 'flip') {
                // 翻页显示模式
                // 首先检查是否需要创建翻页时钟元素
                let flipClock = document.querySelector('.flip-clock');
                if (!flipClock) {
                    // 创建翻页时钟元素
                    const timerDisplay = document.getElementById('timer-display');
                    timerDisplay.innerHTML = ''; // 清空现有内容
                    
                    // 使用原始的翻页时钟HTML结构
                    timerDisplay.innerHTML = `
                        <div class="flip-clock">
                            <div class="flip-card" id="minute-tens">
                                <div class="flip-card-wrapper">
                                    <div class="flip-card-face top">${minTens}</div>
                                    <div class="flip-card-face bottom">${minTens}</div>
                                    <div class="flip-card-face next">${minTens}</div>
                                </div>
                            </div>
                            <div class="flip-card" id="minute-ones">
                                <div class="flip-card-wrapper">
                                    <div class="flip-card-face top">${minOnes}</div>
                                    <div class="flip-card-face bottom">${minOnes}</div>
                                    <div class="flip-card-face next">${minOnes}</div>
                                </div>
                            </div>
                            <div class="colon">:</div>
                            <div class="flip-card" id="second-tens">
                                <div class="flip-card-wrapper">
                                    <div class="flip-card-face top">${secTens}</div>
                                    <div class="flip-card-face bottom">${secTens}</div>
                                    <div class="flip-card-face next">${secTens}</div>
                                </div>
                            </div>
                            <div class="flip-card" id="second-ones">
                                <div class="flip-card-wrapper">
                                    <div class="flip-card-face top">${secOnes}</div>
                                    <div class="flip-card-face bottom">${secOnes}</div>
                                    <div class="flip-card-face next">${secOnes}</div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // 重新获取元素引用
                    minuteTens = document.getElementById('minute-tens');
                    minuteOnes = document.getElementById('minute-ones');
                    secondTens = document.getElementById('second-tens');
                    secondOnes = document.getElementById('second-ones');
                }
                
                // 更新分钟十位数
                if (currentDisplay.minuteTens !== minTens.toString()) {
                    flipCard(minuteTens, minTens);
                    currentDisplay.minuteTens = minTens.toString();
                }
                
                // 更新分钟个位数
                if (currentDisplay.minuteOnes !== minOnes.toString()) {
                    flipCard(minuteOnes, minOnes);
                    currentDisplay.minuteOnes = minOnes.toString();
                }
                
                // 更新秒钟十位数
                if (currentDisplay.secondTens !== secTens.toString()) {
                    flipCard(secondTens, secTens);
                    currentDisplay.secondTens = secTens.toString();
                }
                
                // 更新秒钟个位数
                if (currentDisplay.secondOnes !== secOnes.toString()) {
                    flipCard(secondOnes, secOnes);
                    currentDisplay.secondOnes = secOnes.toString();
                }
            } else {
                // 普通显示模式
                // 首先检查是否需要创建普通时钟元素
                let normalClock = document.querySelector('.flip-clock:not(.digital-clock)');
                if (!normalClock) {
                    // 创建普通时钟元素（复用翻页时钟的HTML结构）
                    const timerDisplay = document.getElementById('timer-display');
                    timerDisplay.innerHTML = ''; // 清空现有内容
                    
                    // 使用原始的翻页时钟HTML结构
                    timerDisplay.innerHTML = `
                        <div class="flip-clock">
                            <div class="flip-card" id="minute-tens">
                                <div class="flip-card-wrapper">
                                    <div class="flip-card-face top">${minTens}</div>
                                    <div class="flip-card-face bottom">${minTens}</div>
                                    <div class="flip-card-face next">${minTens}</div>
                                </div>
                            </div>
                            <div class="flip-card" id="minute-ones">
                                <div class="flip-card-wrapper">
                                    <div class="flip-card-face top">${minOnes}</div>
                                    <div class="flip-card-face bottom">${minOnes}</div>
                                    <div class="flip-card-face next">${minOnes}</div>
                                </div>
                            </div>
                            <div class="colon">:</div>
                            <div class="flip-card" id="second-tens">
                                <div class="flip-card-wrapper">
                                    <div class="flip-card-face top">${secTens}</div>
                                    <div class="flip-card-face bottom">${secTens}</div>
                                    <div class="flip-card-face next">${secTens}</div>
                                </div>
                            </div>
                            <div class="flip-card" id="second-ones">
                                <div class="flip-card-wrapper">
                                    <div class="flip-card-face top">${secOnes}</div>
                                    <div class="flip-card-face bottom">${secOnes}</div>
                                    <div class="flip-card-face next">${secOnes}</div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // 重新获取元素引用
                    minuteTens = document.getElementById('minute-tens');
                    minuteOnes = document.getElementById('minute-ones');
                    secondTens = document.getElementById('second-tens');
                    secondOnes = document.getElementById('second-ones');
                }
                
                // 普通显示模式，直接更新数字
                const cards = [
                    { element: minuteTens, value: minTens },
                    { element: minuteOnes, value: minOnes },
                    { element: secondTens, value: secTens },
                    { element: secondOnes, value: secOnes }
                ];
                
                cards.forEach(card => {
                    const wrapper = card.element.querySelector('.flip-card-wrapper');
                    const topFace = wrapper.querySelector('.top');
                    const bottomFace = wrapper.querySelector('.bottom');
                    const nextFace = wrapper.querySelector('.next');
                    
                    topFace.textContent = card.value;
                    bottomFace.textContent = card.value;
                    nextFace.textContent = card.value;
                });
                
                // 更新当前显示状态
                currentDisplay = {
                    minuteTens: minTens.toString(),
                    minuteOnes: minOnes.toString(),
                    secondTens: secTens.toString(),
                    secondOnes: secOnes.toString()
                };
            }
        }
        
        // 翻页动画
        function flipCard(card, newValue) {
            const wrapper = card.querySelector('.flip-card-wrapper');
            const topFace = wrapper.querySelector('.top');
            const bottomFace = wrapper.querySelector('.bottom');
            const nextFace = wrapper.querySelector('.next');
            
            // 设置下一个数字
            nextFace.textContent = newValue;
            
            // 重置样式
            wrapper.style.position = 'relative';
            topFace.style.transition = 'none';
            nextFace.style.transition = 'none';
            
            // 初始状态设置
            topFace.style.position = 'absolute';
            topFace.style.top = '0';
            topFace.style.opacity = '1';
            topFace.style.transform = 'translateY(0)';
            
            nextFace.style.position = 'absolute';
            nextFace.style.top = '0';
            nextFace.style.opacity = '0';
            nextFace.style.transform = 'translateY(100%)';
            
            // 确保DOM更新
            setTimeout(() => {
                // 添加过渡效果
                topFace.style.transition = 'transform 0.5s ease-out, opacity 0.5s ease-out';
                nextFace.style.transition = 'transform 0.5s ease-out, opacity 0.5s ease-out';
                
                // 开始动画
                topFace.style.transform = 'translateY(-50%)';
                topFace.style.opacity = '0';
                
                nextFace.style.transform = 'translateY(0)';
                nextFace.style.opacity = '1';
                
                // 动画结束后更新状态
                setTimeout(() => {
                    // 更新顶部和底部数字
                    topFace.textContent = newValue.toString();
                    bottomFace.textContent = newValue.toString();
                    
                    // 重置样式
                    topFace.style.transition = 'none';
                    nextFace.style.transition = 'none';
                    topFace.style.transform = 'translateY(0)';
                    topFace.style.opacity = '1';
                    nextFace.style.transform = 'translateY(0)';
                    nextFace.style.opacity = '0';
                }, 500);
            }, 20);
        }
        
        // 记录任务开始
        async function recordTaskStart() {
            if (!currentUser) return;
            
            try {
                const taskData = {
                    taskId: currentTaskId,
                    taskName: currentMode === 'work' ? settings.taskName : '休息一下...', // 确保休息模式使用固定名称
                    startTime: new Date().toISOString(),
                    plannedDuration: totalSeconds,
                    status: 'in-progress',
                    isBreakMode: currentMode === 'break' // 添加休息模式标记
                };
                
                console.log('记录任务开始:', taskData);
                
                // 保存到本地存储作为备份
                saveTaskToLocalStorage(taskData);
                
                // 发送到服务器
                const response = await fetch(`${API_URL}/tasks`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify(taskData)
                });
                
                if (!response.ok) {
                    console.error('记录任务开始失败:', response.status, response.statusText);
                } else {
                    console.log('任务开始记录已保存到服务器');
                }
            } catch (error) {
                console.error('记录任务开始出错:', error);
                // 出错时已经保存到本地存储，无需再次保存
            }
        }
        
        // 记录任务暂停
        async function recordTaskPause() {
            if (!currentUser || !currentTaskId) return;
            
            try {
                const taskData = {
                    pauseTime: new Date().toISOString(),
                    elapsedSeconds: totalSeconds - remainingSeconds
                };
                
                console.log('记录任务暂停:', taskData);
                
                // 发送到服务器
                const response = await fetch(`${API_URL}/tasks/${currentTaskId}/pause`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify(taskData)
                });
                
                if (!response.ok) {
                    console.error('记录任务暂停失败:', response.status, response.statusText);
                    
                    // 保存到本地存储作为备份
                    const existingTasks = JSON.parse(localStorage.getItem('pomodoroTasks') || '[]');
                    const taskIndex = existingTasks.findIndex(task => task.taskId === currentTaskId);
                    
                    if (taskIndex !== -1) {
                        existingTasks[taskIndex].status = 'paused';
                        existingTasks[taskIndex].pauseTime = new Date().toISOString();
                        existingTasks[taskIndex].elapsedSeconds = totalSeconds - remainingSeconds;
                        localStorage.setItem('pomodoroTasks', JSON.stringify(existingTasks));
                    }
                } else {
                    console.log('任务暂停记录已保存到服务器');
                }
            } catch (error) {
                console.error('记录任务暂停出错:', error);
                
                // 出错时保存到本地存储
                const existingTasks = JSON.parse(localStorage.getItem('pomodoroTasks') || '[]');
                const taskIndex = existingTasks.findIndex(task => task.taskId === currentTaskId);
                
                if (taskIndex !== -1) {
                    existingTasks[taskIndex].status = 'paused';
                    existingTasks[taskIndex].pauseTime = new Date().toISOString();
                    existingTasks[taskIndex].elapsedSeconds = totalSeconds - remainingSeconds;
                    localStorage.setItem('pomodoroTasks', JSON.stringify(existingTasks));
                }
            }
        }

        // 记录任务完成
        async function recordTaskComplete() {
            if (!currentUser || !currentTaskId) return;
            
            try {
                const endTime = new Date();
                // 使用计划时间作为实际持续时间
                const actualDuration = totalSeconds; 
                
                const taskData = {
                    endTime: endTime.toISOString(),
                    actualDuration: actualDuration,
                    status: 'completed', // 确保状态为已完成
                    remainingSeconds: 0 // 确保剩余时间为0
                };
                
                console.log('记录任务完成:', taskData);
                
                // 保存到本地存储作为备份
                const existingTasks = JSON.parse(localStorage.getItem('pomodoroTasks') || '[]');
                const taskIndex = existingTasks.findIndex(task => task.taskId === currentTaskId);
                
                if (taskIndex !== -1) {
                    existingTasks[taskIndex] = {
                        ...existingTasks[taskIndex],
                        endTime: endTime.toISOString(),
                        actualDuration: actualDuration,
                        status: 'completed',
                        remainingSeconds: 0
                    };
                    localStorage.setItem('pomodoroTasks', JSON.stringify(existingTasks));
                } else {
                    // 如果在本地存储中找不到任务，创建一个新的完整记录
                    saveTaskToLocalStorage({
                        taskId: currentTaskId,
                        taskName: currentMode === 'work' ? settings.taskName : '休息一下...',
                        startTime: taskStartTime.toISOString(),
                        endTime: endTime.toISOString(),
                        actualDuration: actualDuration,
                        plannedDuration: totalSeconds,
                        status: 'completed',
                        isBreakMode: currentMode === 'break',
                        remainingSeconds: 0
                    });
                }
                
                // 发送到服务器
                const response = await fetch(`${API_URL}/tasks/${currentTaskId}/complete`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify(taskData)
                });
                
                if (!response.ok) {
                    console.error('记录任务完成失败:', response.status, response.statusText);
                } else {
                    console.log('任务完成记录已保存到服务器');
                }
            } catch (error) {
                console.error('记录任务完成出错:', error);
                // 出错时已经保存到本地存储，无需再次保存
            }
        }

        // 记录任务放弃
        async function recordTaskAbandoned() {
            if (!currentUser || !currentTaskId || !taskStartTime) return;
            
            try {
                const elapsedSeconds = totalSeconds - remainingSeconds;
                
                const taskData = {
                    endTime: new Date().toISOString(),
                    actualDuration: elapsedSeconds, // 已经过的时间
                    status: 'abandoned',
                    remainingSeconds: remainingSeconds // 记录剩余时间
                };
                
                console.log('记录任务放弃:', taskData);
                
                // 保存到本地存储作为备份
                const existingTasks = JSON.parse(localStorage.getItem('pomodoroTasks') || '[]');
                const taskIndex = existingTasks.findIndex(task => task.taskId === currentTaskId);
                
                if (taskIndex !== -1) {
                    existingTasks[taskIndex] = {
                        ...existingTasks[taskIndex],
                        endTime: taskData.endTime,
                        actualDuration: taskData.actualDuration,
                        status: 'abandoned',
                        remainingSeconds: remainingSeconds
                    };
                    localStorage.setItem('pomodoroTasks', JSON.stringify(existingTasks));
                } else {
                    // 如果在本地存储中找不到任务，创建一个新的完整记录
                    saveTaskToLocalStorage({
                        taskId: currentTaskId,
                        taskName: currentMode === 'work' ? settings.taskName : '休息一下...',
                        startTime: taskStartTime.toISOString(),
                        endTime: taskData.endTime,
                        actualDuration: elapsedSeconds,
                        plannedDuration: totalSeconds,
                        status: 'abandoned',
                        isBreakMode: currentMode === 'break',
                        remainingSeconds: remainingSeconds
                    });
                }
                
                // 发送到服务器
                const response = await fetch(`${API_URL}/tasks/${currentTaskId}/abandon`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify(taskData)
                });
                
                if (!response.ok) {
                    console.error('记录任务放弃失败:', response.status, response.statusText);
                } else {
                    console.log('任务放弃记录已保存到服务器');
                }
            } catch (error) {
                console.error('记录任务放弃出错:', error);
                // 出错时已经保存到本地存储，无需再次保存
            }
        }

              // 添加本地存储功能
              function saveTaskToLocalStorage(task) {
            try {
                // 确保任务数据格式一致
                const standardizedTask = {
                    taskId: task.taskId,
                    taskName: task.taskName,
                    startTime: task.startTime,
                    endTime: task.endTime || new Date().toISOString(),
                    actualDuration: task.actualDuration || 0,
                    plannedDuration: task.plannedDuration || totalSeconds,
                    status: task.status,
                    isBreakMode: task.isBreakMode || false,
                    remainingSeconds: task.remainingSeconds,
                    elapsedSeconds: task.elapsedSeconds || (task.plannedDuration - task.remainingSeconds)
                };
                
                const existingTasks = JSON.parse(localStorage.getItem('pomodoroTasks') || '[]');
                
                // 检查是否已存在相同ID的任务
                const taskIndex = existingTasks.findIndex(t => t.taskId === task.taskId);
                if (taskIndex >= 0) {
                    // 更新现有任务
                    existingTasks[taskIndex] = standardizedTask;
                } else {
                    // 添加新任务
                    existingTasks.push(standardizedTask);
                }
                
                localStorage.setItem('pomodoroTasks', JSON.stringify(existingTasks));
                console.log('任务已保存到本地存储:', standardizedTask);
            } catch (e) {
                console.error('保存任务到本地存储失败:', e);
            }
        }
        
                 // 开始计时器
        function startTimer() {
            if (isRunning) return;
            
            // 如果是重新开始，则生成新的任务ID
            if (remainingSeconds === totalSeconds) {
                currentTaskId = Date.now().toString();
                taskStartTime = new Date();
                
                // 记录任务开始
                recordTaskStart();
            }
            
            isRunning = true;
            startBtn.disabled = true;
            pauseBtn.disabled = false;
            
            timer = setInterval(() => {
                remainingSeconds--;
                
                if (remainingSeconds <= 0) {
                    clearInterval(timer);
                    isRunning = false;
                    
                    // 播放提示音
                    const audio = new Audio('https://assets.mixkit.co/sfx/preview/mixkit-alarm-digital-clock-beep-989.mp3');
                    audio.play();
                    
                    // 记录任务完成 - 确保在切换模式前记录完成状态
                    recordTaskComplete();
                    
                    // 延迟切换模式，确保任务记录完成
                    setTimeout(() => {
                        // 重置按钮状态
                        startBtn.disabled = false;
                        pauseBtn.disabled = true;
                        
                        // 重置任务ID和开始时间，确保下一个任务有新的ID
                        currentTaskId = null;
                        taskStartTime = null;
                        
                        // 自动切换模式
                        switchMode(currentMode === 'work' ? 'break' : 'work');
                    }, 500);
                }
                
                updateTimerDisplay();
            }, 1000);
        }
        
        // 暂停计时器
        function pauseTimer() {
            if (!isRunning) return;
            
            clearInterval(timer);
            isRunning = false;
            startBtn.disabled = false;
            pauseBtn.disabled = true;
            
            // 记录任务暂停
            recordTaskPause();
        }
        
        // 重置计时器
        function resetTimer() {
            clearInterval(timer);
            isRunning = false;
            
            // 如果计时器曾经开始过（有任务ID）且不是刚开始，则记录任务放弃
            if (currentTaskId && remainingSeconds < totalSeconds) {
                recordTaskAbandoned();
            }
            
            // 重置时间
            remainingSeconds = totalSeconds;
            updateTimerDisplay();
            
            // 重置按钮状态
            startBtn.disabled = false;
            pauseBtn.disabled = true;
            
            // 重置任务ID
            currentTaskId = null;
            taskStartTime = null;
        }

        // 计时完成
        function timerComplete() {
            alert(`${currentMode === 'work' ? '工作' : '休息'}时间到！`);
            
            // 记录任务完成
            if (currentMode === 'work') {
                recordTaskComplete();
            }
            
            // 重置任务ID和开始时间
            currentTaskId = null;
            taskStartTime = null;
            
            switchMode(currentMode === 'work' ? 'break' : 'work');
            startTimer();
        }
        
        // 切换模式
        function switchMode(mode) {
            currentMode = mode;
            
            if (mode === 'work') {
                workModeBtn.classList.add('bg-indigo-600', 'text-white');
                workModeBtn.classList.remove('text-gray-300');
                breakModeBtn.classList.remove('bg-indigo-600', 'text-white');
                breakModeBtn.classList.add('text-gray-300');
                totalSeconds = settings.workTime * 60;
                
                // 在工作模式下显示任务名称
                currentTaskDisplay.textContent = settings.taskName;
            } else {
                breakModeBtn.classList.add('bg-indigo-600', 'text-white');
                breakModeBtn.classList.remove('text-gray-300');
                workModeBtn.classList.remove('bg-indigo-600', 'text-white');
                workModeBtn.classList.add('text-gray-300');
                totalSeconds = settings.breakTime * 60;
                
                // 在休息模式下显示固定文本
                currentTaskDisplay.textContent = "休息一下...";
            }
            
            // 调整动态背景色调
            if (mode === 'work') {
                dynamicBg.style.filter = 'hue-rotate(0deg)'; // 冷色调
            } else {
                dynamicBg.style.filter = 'hue-rotate(90deg)'; // 暖色调
            }
            
            resetTimer();
            
            // 确保模式切换后立即更新显示
            console.log('当前模式:', currentMode, '显示文本:', currentTaskDisplay.textContent);
        }
        
        // 打开设置面板
        function openSettings() {
            settingsPanel.classList.add('open');
            // 加载当前设置到表单
            workTimeSelect.value = settings.workTime !== 25 && settings.workTime !== 30 && 
                                   settings.workTime !== 40 && settings.workTime !== 60 ? 'custom' : settings.workTime;
            breakTimeSelect.value = settings.breakTime !== 5 && settings.breakTime !== 10 && 
                                    settings.breakTime !== 15 && settings.breakTime !== 20 ? 'custom' : settings.breakTime;
            
            // 设置任务名称输入框的值
            taskNameInput.value = settings.taskName !== '专注工作中...' ? settings.taskName : '';

            if (workTimeSelect.value === 'custom') {
                customWorkContainer.classList.remove('hidden');
                customWorkTime.value = settings.workTime;
            }
            
            if (breakTimeSelect.value === 'custom') {
                customBreakContainer.classList.remove('hidden');
                customBreakTime.value = settings.breakTime;
            }
            
            // 更新显示模式按钮状态
            document.getElementById('flip-display').classList.remove('bg-indigo-600', 'bg-gray-700');
            document.getElementById('normal-display').classList.remove('bg-indigo-600', 'bg-gray-700');
            document.getElementById('digital-display').classList.remove('bg-indigo-600', 'bg-gray-700');
            
            document.getElementById('flip-display').classList.add(settings.displayMode === 'flip' ? 'bg-indigo-600' : 'bg-gray-700');
            document.getElementById('normal-display').classList.add(settings.displayMode === 'normal' ? 'bg-indigo-600' : 'bg-gray-700');
            document.getElementById('digital-display').classList.add(settings.displayMode === 'digital' ? 'bg-indigo-600' : 'bg-gray-700');
        }

                // 保存任务到数据库
                async function saveTaskToDatabase(task) {
            try {
                const response = await fetch(`${API_URL}/pomodoro/tasks`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(task)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('任务保存成功:', result);
                    
                    // 更新本地任务，标记为已同步
                    task.synced = true;
                    task.id = result.id || task.id; // 使用服务器返回的ID
                    
                    // 更新本地存储
                    updateLocalStorage();
                    
                    return result;
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    console.error('保存任务失败:', errorData);
                    throw new Error(errorData.message || '保存任务到数据库失败');
                }
            } catch (error) {
                console.error('保存任务到数据库出错:', error);
                // 即使保存到数据库失败，也要保存到本地存储
                updateLocalStorage();
                return null;
            }
        }

                // 在任务完成或放弃时调用
                function finishTask(status) {
            if (!currentTask) return;
            
            // 更新任务状态
            currentTask.status = status;
            currentTask.endTime = new Date().toISOString();
            
            if (status === 'completed') {
                // 计算实际持续时间（秒）
                currentTask.actualDuration = currentTask.plannedDuration;
                showToast('success', '恭喜！任务完成！');
            } else {
                // 已放弃任务
                currentTask.actualDuration = currentTask.plannedDuration - timerSeconds;
                showToast('warning', '任务已放弃');
            }
            
            // 保存到任务历史
            tasks.push(currentTask);
            
            // 保存到数据库
            saveTaskToDatabase(currentTask).catch(error => {
                console.error('保存任务到数据库失败:', error);
                showToast('error', '同步到云端失败，已保存到本地');
            });
            
            // 重置当前任务
            resetTimer();
            updateLocalStorage();
            renderTaskHistory();
        }
        
        // 关闭设置面板
        function closeSettingsPanel() {
            settingsPanel.classList.remove('open');
        }
        
                // 保存设置
                function saveSettings() {
            settings.workTime = workTimeSelect.value === 'custom' ? 
                parseInt(customWorkTime.value) || settings.workTime : 
                parseInt(workTimeSelect.value);
            
            settings.breakTime = breakTimeSelect.value === 'custom' ? 
                parseInt(customBreakTime.value) || settings.breakTime : 
                parseInt(breakTimeSelect.value);
            
            // 保存任务名称
            settings.taskName = taskNameInput.value.trim() || '专注工作中...';
            
            // 更新任务名称显示（只在工作模式下）
            if (currentMode === 'work') {
                updateTaskDisplay();
            }
            
            // 保存到本地存储
            localStorage.setItem('pomodoroSettings', JSON.stringify(settings));
            
            // 应用新设置
            switchMode(currentMode);
            applyBackground();
            
            closeSettingsPanel();
        }

        // 添加更新任务名称显示的函数
        function updateTaskDisplay() {
            // 只在工作模式下更新任务名称显示
            if (currentMode === 'work') {
                currentTaskDisplay.textContent = settings.taskName;
            }
            // 休息模式下保持固定文本"休息一下..."
        }
        
        // 加载设置
        function loadSettings() {
            const savedSettings = localStorage.getItem('pomodoroSettings');
            if (savedSettings) {
                settings = JSON.parse(savedSettings);
            }
            
            // 更新任务名称显示
            updateTaskDisplay();
        }
        
                // 应用背景设置
                function applyBackground() {
            // 检查是否有自定义静态背景
            const savedBg = localStorage.getItem('customBg');
            if (savedBg) {
                staticBg.style.backgroundImage = `url(${savedBg})`;
                
                // 如果有自定义静态背景，默认禁用动态背景
                if (settings.dynamicBg !== 'none') {
                    settings.dynamicBg = 'none';
                    saveSettings();
                }
                
                staticBg.style.opacity = '0.7';
                dynamicBg.className = 'dynamic-bg';
            } else {
                // 应用动态背景
                setDynamicBackground(settings.dynamicBg || 'aurora');
            }
            
            // 根据当前模式调整色调
            if (currentMode === 'work') {
                dynamicBg.style.filter = 'hue-rotate(0deg)'; // 冷色调
            } else {
                dynamicBg.style.filter = 'hue-rotate(90deg)'; // 暖色调
            }
        }
        
        // 处理背景上传
        function handleBgUpload(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const bgUrl = event.target.result;
                    staticBg.style.backgroundImage = `url(${bgUrl})`;
                    localStorage.setItem('customBg', bgUrl);
                    
                    // 上传静态背景时，禁用动态背景
                    setDynamicBackground('none');
                    settings.dynamicBg = 'none';
                    saveSettings();
                };
                reader.readAsDataURL(file);
            }
        }
        
        // 删除背景
        function removeBackground() {
            // 重置为默认背景
            staticBg.style.backgroundImage = 'url("https://source.unsplash.com/random/1920x1080/?nature")';
            // 从本地存储中删除自定义背景
            localStorage.removeItem('customBg');
        }
        
        // 初始化应用
        document.addEventListener('DOMContentLoaded', init);
        // 添加拖动功能
        const mainContainer = document.querySelector('.main-container');
        let isDragging = false;
        let offsetX, offsetY;
        
        // 鼠标按下事件
        mainContainer.addEventListener('mousedown', (e) => {
            // 如果点击的是按钮或输入框等交互元素，不启动拖动
            if (e.target.tagName === 'BUTTON' || 
                e.target.tagName === 'INPUT' || 
                e.target.tagName === 'SELECT' ||
                e.target.closest('.control-buttons') ||
                e.target.closest('.flip-clock')) {
                return;
            }
            
            isDragging = true;
            
            // 计算鼠标在容器内的相对位置
            const rect = mainContainer.getBoundingClientRect();
            offsetX = e.clientX - rect.left;
            offsetY = e.clientY - rect.top;
            
            // 添加临时样式
            mainContainer.style.transition = 'none';
            mainContainer.style.cursor = 'grabbing';
        });
        
        // 鼠标移动事件
        document.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            
            // 计算新位置
            const x = e.clientX - offsetX;
            const y = e.clientY - offsetY;
            
            // 应用新位置，使用translate而不是left/top以获得更好的性能
            mainContainer.style.transform = `translate(0, 0)`;
            mainContainer.style.left = `${x}px`;
            mainContainer.style.top = `${y}px`;
            
            // 防止默认行为和事件传播
            e.preventDefault();
        });
        
        // 鼠标释放事件
        document.addEventListener('mouseup', () => {
            if (isDragging) {
                isDragging = false;
                mainContainer.style.cursor = 'move';
            }
        });
        
        // 鼠标离开窗口事件
        document.addEventListener('mouseleave', () => {
            if (isDragging) {
                isDragging = false;
                mainContainer.style.cursor = 'move';
            }
        });
    </script>
</body>
</html>